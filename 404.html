

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Secure File Viewer</title>

<!-- PDF.js Library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.2.67/pdf.min.js"></script>
<script>
pdfjsLib.GlobalWorkerOptions.workerSrc =
  "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.2.67/pdf.worker.min.js";
</script>

<!-- SheetJS (Excel Viewer) -->
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

<style>
body, html { margin: 0; padding: 0; height: 100%; background: #f4f4f4; font-family: sans-serif; }

#loader { display: flex; justify-content: center; align-items: center; height: 100vh; flex-direction: column; }
.spinner { border: 4px solid rgba(0,0,0,0.1); border-top: 4px solid #333; width: 40px; height: 40px; border-radius: 50%; animation: spin 1s linear infinite; }
@keyframes spin { 100% { transform: rotate(360deg); } }

#pdf-container { display: none; width: 100%; text-align: center; }
#pdfCanvas { width: 100%; max-width: 900px; margin: auto; display: block; }

#excel-container { display: none; max-width: 900px; margin: 30px auto; background: white; padding: 20px; }
table { border-collapse: collapse; width: 100%; font-size: 14px; }
th, td { border: 1px solid #ddd; padding: 8px; }
th { background: #f8f9fa; }

#error-msg { color: red; text-align: center; padding: 30px; display: none; }
</style>
</head>

<body>

<div id="loader">
    <div class="spinner"></div>
    <p>Loading document...</p>
</div>

<div id="error-msg"></div>

<div id="pdf-container">
    <canvas id="pdfCanvas"></canvas>
</div>

<div id="excel-container">
    <h2 id="file-title"></h2>
    <button id="download-btn">Download Original</button>
    <div id="excel-content"></div>
</div>


<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyAemGs7FBW94fcx0Ncrhi_caJvUfAutejnPvzgGt6S66yfOW_pY36rQGr0VgFTQUUALg/exec"; 

    async function init() {
        // Extract filename from URL (e.g., "2025.pdf")
        const path = window.location.pathname;
        const segments = path.split('/').filter(Boolean);
        const fileName = segments.length > 0 ? segments[segments.length - 1] : null;

        if (!fileName) {
            showError("No filename found in URL.");
            return;
        }

        // Detect File Type
        const ext = fileName.split('.').pop().toLowerCase();
        const isExcel = ['xls', 'xlsx', 'csv'].includes(ext);
        const isPdf = ['pdf'].includes(ext);

        if (!isExcel && !isPdf) {
            showError("Unsupported file type: " + ext);
            return;
        }

        try {
            // Fetch Data
            const response = await fetch(`${SCRIPT_URL}?file=${encodeURIComponent(fileName)}`);
            const result = await response.json();

            if (result.status !== 'success') {
                throw new Error("File not found in database.");
            }

            // Handle Rendering based on type
            if (isPdf) {
                // *** This is the updated, cross-platform PDF render function. ***
                renderPdf(result.data);
            } else if (isExcel) {
                renderExcel(result.data, result.filename);
            }

        } catch (error) {
            showError(error.message);
        }
    }

    /**
     * Renders a PDF file reliably on both desktop and mobile.
     * On mobile, it navigates the entire page to the Blob URL, forcing the
     * native OS/browser PDF viewer to open.
     */
    function renderPdf(base64Data) {
        const blob = base64ToBlob(base64Data, "application/pdf");
        const pdfUrl = URL.createObjectURL(blob);
        
        // Hide the loader before navigating or setting iframe src
        document.getElementById('loader').style.display = 'none';

        // Check for mobile/tablet heuristic (not perfect, but covers most)
        const isMobile = /Mobi|Android/i.test(navigator.userAgent);
        
        if (isMobile) {
            // CRITICAL FIX FOR MOBILE BROWSERS: Navigate the page to the Blob URL
            // This bypasses iframe issues and uses the native viewer.
            window.location.assign(pdfUrl);
        } else {
            // Desktop/Reliable Environments: Use iframe
            const iframe = document.getElementById('pdf-frame');
            iframe.src = pdfUrl;
            iframe.style.display = 'block';
        }
    }


    function renderExcel(base64Data, filename) {
        // 1. Read the Base64 data using SheetJS
        const workbook = XLSX.read(base64Data, {type: 'base64'});

        // 2. Get the first sheet name
        const firstSheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[firstSheetName];

        // 3. Convert sheet to HTML Table
        const htmlTable = XLSX.utils.sheet_to_html(worksheet);

        // 4. Inject into DOM
        document.getElementById('excel-content').innerHTML = htmlTable;
        document.getElementById('file-title').innerText = filename;
        
        // 5. Setup Download Button
        document.getElementById('download-btn').onclick = () => {
            const blob = base64ToBlob(base64Data, "application/vnd.ms-excel");
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
        };

        // Switch Views
        document.getElementById('loader').style.display = 'none';
        document.getElementById('excel-container').style.display = 'block';
    }

    // Helper: Convert Base64 to Blob
    function base64ToBlob(base64, mimeType) {
        const byteCharacters = atob(base64);
        const byteNumbers = new Array(byteCharacters.length);
        for (let i = 0; i < byteCharacters.length; i++) {
            byteNumbers[i] = byteCharacters.charCodeAt(i);
        }
        const byteArray = new Uint8Array(byteNumbers);
        return new Blob([byteArray], {type: mimeType});
    }

    function showError(msg) {
        document.getElementById('loader').style.display = 'none';
        const errDiv = document.getElementById('error-msg');
        errDiv.innerText = msg;
        errDiv.style.display = 'block';
    }

    init();
</script>

</body>
</html>



  
