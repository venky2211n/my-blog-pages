<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Secure File Viewer</title>

<script src="https://cdn.tailwindcss.com"></script>

<!-- PDF.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.9.179/pdf.min.js"></script>
<script>
pdfjsLib.GlobalWorkerOptions.workerSrc =
  "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.9.179/pdf.worker.min.js";
</script>

<!-- SheetJS -->
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

<style>
body, html { margin: 0; padding: 0; min-height: 100vh; font-family: 'Inter', sans-serif; }
#loader { display: flex; justify-content: center; align-items: center; min-height: 100vh; flex-direction: column; }
.spinner { border: 4px solid rgba(0,0,0,0.1); border-top: 4px solid #3b82f6; width: 40px; height: 40px; border-radius: 50%; animation: spin 1s linear infinite; }
@keyframes spin { 100% { transform: rotate(360deg); } }
.pdf-page-canvas { margin: 0 auto 20px auto; box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: block; border-radius: 8px; }
</style>
</head>

<body class="bg-gray-100">

<!-- LOADER -->
<div id="loader">
    <div class="spinner"></div>
    <p class="mt-4 text-gray-600">Loading document securely...</p>
</div>

<!-- ERROR BOX -->
<div id="error-msg" class="hidden text-center p-4 m-8 bg-red-100 border border-red-400 text-red-700 rounded-lg max-w-lg mx-auto"></div>

<!-- TOOLBAR -->
<div id="toolbar" class="hidden w-full text-center mt-4 space-x-3">

    <!-- DOWNLOAD -->
    <button id="btn-download" class="bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md">
        â¬‡ Download
    </button>

    <!-- PRINT -->
    <button id="btn-print" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md">
        ðŸ–¨ Print
    </button>

    <!-- ZOOM IN -->
    <button onclick="zoomIn()" class="bg-gray-700 hover:bg-gray-800 text-white font-bold py-2 px-4 rounded-lg shadow-md">
        âž• Zoom In
    </button>

    <!-- ZOOM OUT -->
    <button onclick="zoomOut()" class="bg-gray-700 hover:bg-gray-800 text-white font-bold py-2 px-4 rounded-lg shadow-md">
        âž– Zoom Out
    </button>

</div>

<!-- PDF VIEW -->
<div id="pdf-container" class="max-w-4xl mx-auto p-4 md:p-8"></div>

<!-- EXCEL VIEW -->
<div id="excel-container" class="hidden max-w-4xl mx-auto p-4"></div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzlwPSVllwkjugj3xAMhF6TE25DExYcRh1n_jMN17K0cDEl6YGqLpPxZma7zrjZ0Kge/exec";

let globalBase64 = "";
let globalFileName = "";
let globalMime = "";

// Zoom value
let zoom = 1.0;
let pdfGlobal = null;

async function init() {
    const path = window.location.pathname.split("/");
    const fileName = path.pop();
    const ext = fileName.split(".").pop().toLowerCase();

    const isPdf = ext === "pdf";
    const isExcel = ["xls", "xlsx", "csv"].includes(ext);

    const response = await fetch(`${SCRIPT_URL}?fileName=${fileName}`);
    const result = await response.json();

    if (result.status !== "success") {
        showError(result.error);
        return;
    }

    globalBase64 = result.data;
    globalFileName = result.filename;
    globalMime = result.mime;

    // Show toolbar
    document.getElementById("toolbar").classList.remove("hidden");

    // Download button
    document.getElementById("btn-download").onclick = downloadOriginal;

    // Print button
    document.getElementById("btn-print").onclick = printPDF;

    if (isPdf) renderPdf(result.data);
    else if (isExcel) renderExcel(result.data);
}

async function renderPdf(base64Data) {
    document.getElementById("loader").style.display = "none";

    const container = document.getElementById("pdf-container");
    container.innerHTML = "";
    container.classList.remove("hidden");

    const pdfData = atob(base64Data);
    pdfGlobal = await pdfjsLib.getDocument({ data: pdfData }).promise;

    for (let n = 1; n <= pdfGlobal.numPages; n++) {
        const page = await pdfGlobal.getPage(n);
        const viewport = page.getViewport({ scale: zoom });

        const canvas = document.createElement("canvas");
        canvas.className = "pdf-page-canvas";
        canvas.width = viewport.width;
        canvas.height = viewport.height;

        await page.render({
            canvasContext: canvas.getContext("2d"),
            viewport: viewport
        }).promise;

        container.appendChild(canvas);
    }
}

function zoomIn() {
    zoom += 0.2;
    renderPdf(globalBase64);
}

function zoomOut() {
    zoom = Math.max(0.4, zoom - 0.2);
    renderPdf(globalBase64);
}

function printPDF() {
    const pdfWindow = window.open("");
    pdfWindow.document.write(
        `<iframe width='100%' height='100%' src='data:application/pdf;base64,${globalBase64}'></iframe>`
    );
}

function renderExcel(base64Data) {
    document.getElementById("loader").style.display = "none";

    const wb = XLSX.read(base64Data, { type: "base64" });
    const sheet = wb.Sheets[wb.SheetNames[0]];
    const html = XLSX.utils.sheet_to_html(sheet);

    const box = document.getElementById("excel-container");
    box.innerHTML = html;
    box.classList.remove("hidden");
}

function downloadOriginal() {
    const a = document.createElement("a");
    a.href = "data:" + globalMime + ";base64," + globalBase64;
    a.download = globalFileName;
    a.click();
}

function showError(msg) {
    document.getElementById("loader").style.display = "none";
    const box = document.getElementById("error-msg");
    box.innerHTML = msg;
    box.classList.remove("hidden");
}

init();
</script>

</body>
</html>
